<?php
//einbinden plugin

/*
Plugin Name: vLib Graphen
Plugin URI: www.google.at
Description: Graphengenerator
Author: AG,MG
Version: 1.0
Author URI: www.google.at
*/



wp_register_script('vlib_script', plugins_url('myjs.js', __FILE__));
//wp_enqueue_script('jQuery');
wp_enqueue_script('vlib_script');


// push data to script
//plugin_path
$data = array(
  'plugin_url' => plugins_url('',__FILE__),
  'wpurl' => plugins_url('', __FILE__ )
  );
wp_localize_script('vlib_script', 'vlib_', $data );



function wpb_adding_scripts(){
  wp_register_script('vlib_script_be', plugins_url('backendjs.js', __FILE__));
  wp_enqueue_script('vlib_script_be');
}

wp_localize_script('vlib_script_be', 'vlib_', array( 'plugin_url' => plugins_url('',__FILE__) ));

add_action('admin_init', 'wpb_adding_scripts');


function create_Main_page() {
  ?>
  <h1>vLib</h1>
  <a href="admin.php?page=start">Start</a><br />
  <?PHP
}


function start() {

  $dir = plugin_dir_url( __FILE__ );
  echo "<iframe style='width:100%;height:600px'
  src='$dir/VLib/index.html' allowFullScreen></iframe>";


}

function formtest() {

  $dir = plugin_dir_url( __FILE__ );
  echo $dir;
//$dir/process.php

  echo "<div class='wrap'>
  <h2>Form test</h2>
  <form name='product_form' action='' method='post' id='newDBEntry'>
    <h4 id='test'>test</h4>
    <p>name<input type='text' name='name' value='4' size='20'></p>
    <p>url<input type='text' name='url' value='2' size='20'></p>
    <p>text<input type='text' name='text' value='1' size='20'></p>
    <input type='hidden' name='action' value='addToDB'/>
    <p class='submit'>
      <input type='submit' name='Submit' value='Submit' />
    </p>
  </form>
  <br/><br/>
  <div id='feedback'></div>
  <br/><br/>

</div>";
}

add_action('admin_menu', 'profileAddMenu');

function profileAddMenu() {
  add_menu_page('vLib', 'vLib', 10, __FILE__, 'create_Main_page');
  add_submenu_page(__FILE__, 'Start', 'Start', 10, 'start', 'start');

 //  add_submenu_page(__FILE__, 'Formtest', 'Formtest', 10, 'formtest', 'formtest');


}

global $vlib_db_version;
$vlib_db_version = "1.0";

function vlib_install() {
 global $wpdb;
 global $vlib_db_version;

 $table_name = $wpdb->prefix . "vlib_templates";

 $sql = "CREATE TABLE $table_name (
  id mediumint(9) NOT NULL AUTO_INCREMENT,
  time datetime DEFAULT '0000-00-00 00:00:00' NOT NULL,
  template_name tinytext NOT NULL,
  template_description text NOT NULL,
  template_graph longtext NOT NULL,
  UNIQUE KEY id (id)
  );";

require_once( ABSPATH . 'wp-admin/includes/upgrade.php' );
dbDelta( $sql );

$table_name = $wpdb->prefix . "vlib_files";
$sql = "CREATE TABLE $table_name (
  id mediumint(9) NOT NULL AUTO_INCREMENT,
  time datetime DEFAULT '0000-00-00 00:00:00' NOT NULL,
  file_name tinytext NOT NULL,
  file_description text NOT NULL,
  file_path text NOT NULL,
  coord_one text NOT NULL,
  coord_two text NOT NULL,
  coord_three text NOT NULL,
  UNIQUE KEY id (id)
  );";

dbDelta( $sql );

add_option( "vlib_db_version", $vlib_db_version );
}

function vlib_install_data() {
  // global $wpdb;
  // $welcome_name = "TestName";
  // $welcome_text = "TestText";
  // $table_name = $wpdb->prefix . "vlib";
  // $rows_affected = $wpdb->insert( $table_name, array( 'time' => current_time('mysql'), 'template_name' => $welcome_name, 'template_description' => $welcome_text ) );
}

register_activation_hook( __FILE__, 'vlib_install' );
register_activation_hook( __FILE__, 'vlib_install_data' );

wp_enqueue_script('jquery');

function addToDB(){

  global $wpdb;

  $name=$_POST['name'];
  $text=$_POST['text'];
  $url=$_POST['url'];

  if($wpdb->insert('vlib',array(
    'name'=>$name,
    'text'=>$text,
    'url'=>$url
    ))===FALSE){

    echo "Error";

}
else {
  echo "Entry '".$name. "' successfully added, row ID is ".$wpdb->insert_id;

}
die();
}
add_action('wp_ajax_addToDB', 'addToDB');
add_action('wp_ajax_nopriv_addToDB', 'addToDB'); // not really needed


//shortcode
function get_vlib_plot($atts){
 extract(shortcode_atts(array(
  'id' => 1,
  ), $atts));

 return  '<div id="' .$id. '" class="vlib-plot" style="min-height:300px;border: 1px solid #ccc; background-color:white; position:relative;" ></div>';
}

function register_shortcodes(){
 add_shortcode('vlib', 'get_vlib_plot');
}

add_action( 'init', 'register_shortcodes');




?>
