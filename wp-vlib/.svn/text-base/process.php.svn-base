<?php

require_once("../../../wp-config.php");

require_once(ABSPATH . "wp-admin" . '/includes/image.php');
require_once(ABSPATH . "wp-admin" . '/includes/file.php');
require_once(ABSPATH . "wp-admin" . '/includes/media.php');

$table_name = $wpdb->prefix . "vlib_templates";

 if(isset($_POST["json"])){

    $json = stripslashes($_POST["json"]);

	$obj = json_decode($json, TRUE);

	 $action =  htmlspecialchars(trim($obj['action']));

	 switch ( $action ) {
	 case 'save':
			$name=$obj['name'];
			$descr=$obj['description'];
			$graph=json_encode($obj['sceneGraph']);

			$insert = "INSERT INTO " . $table_name .
						" (template_name, template_description, template_graph) " .
						"VALUES ('$name','$descr','$graph')";
			$results = $wpdb->query( $insert );

			if( $results == 1)
				print "Template was stored in database.";
			else
				print "There has been an error saving the template";
	 break;
	 case 'delete_t':
			$name=$obj['name'];
			$tId = $obj["id"];
			//$name_id = explode('-', $name, 2);


			$delete = "DELETE FROM " . $table_name .
						" WHERE id=" . $tId;
			$results = $wpdb->query( $delete );

			if( $results === 1){
				print $results;
			}else{
				print "There has been an error deleting the template!";
			}
	 break;
	 case 'get_t':

		$sql = "SELECT * FROM ". $table_name ;
		$results = $wpdb->get_results($sql) or die(mysql_error());
		if (count($results) > 0) {
			print json_encode($results);
		}

	 break;
	 case 'get_t_id':
	 		$id=$obj['id'];


		$sql = "SELECT * FROM ". $table_name .
				" WHERE id=" . $id;
		$results = $wpdb->get_results($sql) or die(mysql_error());
		if (count($results) > 0) {
			print json_encode($results);
		}

	 break;
	 case 'get_files':

		$sql = "SELECT * FROM ". $wpdb->prefix . "vlib_files" ;
		$results = $wpdb->get_results($sql) or die(mysql_error());
		if (count($results) > 0) {
			print json_encode($results);
		}
     break;
	 case 'delete_files':

			$files_ids = implode(",",$obj['files']);

			$delete = "DELETE FROM " . $wpdb->prefix . "vlib_files".
						" WHERE id IN (" . $files_ids .")";
			$results = $wpdb->query( $delete );

			if (count($results) > 0) {
				print $results;
			}else{
				print $delete . "There has been an error deleting the template! ";
			}
	 break;
	 default:
	 }

 }


function t_save($obj) {
global $wpdb;


}

function t_delete($obj) {
global $wpdb;
	$name=$obj['name'];
	$descr=$obj['description'];
	$graph=json_encode($obj['sceneGraph']);


	$insert = "INSERT INTO " . $table_name .
				" (template_name, template_description, template_graph) " .
				"VALUES ('$name','$descr','$graph')";
	$results = $wpdb->query( $insert );

	if( $results == 1)
		print "Template was stored in database.";
	else
		print $results ;
}



?>
